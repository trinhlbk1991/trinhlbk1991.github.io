<!-- Search Modal Dialog -->
<div
    id="searchModal"
    class="hidden fixed inset-0 z-[9999] overflow-y-auto"
    aria-labelledby="search-modal"
    role="dialog"
    aria-modal="true"
>
    <!-- Backdrop with Blur -->
    <div
        id="searchBackdrop"
        class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm transition-all"
        aria-hidden="true"
    >
    </div>

    <!-- Spotlight-style Modal Content -->
    <div class="flex min-h-screen items-center justify-center p-4 sm:p-6">
        <div class="relative w-full max-w-3xl">
            <!-- Spotlight Search Box -->
            <div
                class="relative bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl shadow-2xl overflow-hidden"
            >
                <!-- Search Input -->
                <div
                    class="relative border-b border-gray-200 dark:border-gray-700"
                >
                    <input
                        type="text"
                        id="headerSearchInput"
                        placeholder="Search posts..."
                        class="w-full px-4 sm:px-6 py-4 sm:py-6 pl-12 sm:pl-16 pr-12 sm:pr-16 text-lg sm:text-2xl text-gray-900 dark:text-gray-100 bg-transparent border-0 focus:ring-0 outline-none placeholder-gray-400"
                        autofocus
                    />
                    <svg
                        class="absolute left-4 sm:left-6 top-1/2 transform -translate-y-1/2 w-5 h-5 sm:w-7 sm:h-7 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path>
                    </svg>
                    <!-- Close Button -->
                    <button
                        id="closeSearch"
                        type="button"
                        class="absolute right-4 sm:right-6 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"
                        aria-label="Close search"
                    >
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Search Results -->
                <div class="max-h-[60vh] overflow-y-auto">
                    <div id="headerSearchResults" class="p-4"></div>

                    <!-- Loading Indicator -->
                    <div
                        id="headerSearchLoading"
                        class="hidden text-center text-gray-600 dark:text-gray-400 py-12"
                    >
                        <div
                            class="animate-spin inline-block w-8 h-8 border-3 border-primary border-t-transparent rounded-full"
                        >
                        </div>
                        <p class="mt-3 text-base">Searching...</p>
                    </div>
                </div>
            </div>

            <!-- Keyboard Shortcuts Hint -->
            <div class="mt-4 text-center hidden sm:block">
                <p class="text-sm text-gray-400 dark:text-gray-500">
                    <kbd
                        class="px-2 py-1 bg-gray-700 dark:bg-gray-600 text-white rounded text-xs"
                        >ESC</kbd
                    > to close
                    <span class="mx-2">•</span>
                    <kbd
                        class="px-2 py-1 bg-gray-700 dark:bg-gray-600 text-white rounded text-xs"
                        >⌘K</kbd
                    > to open
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    import Fuse from "fuse.js";

    let fuse: Fuse<any> | null = null;
    let posts: any[] = [];

    // Fetch and initialize search index
    async function initHeaderSearch() {
        try {
            const response = await fetch("/api/search.json");
            const allPosts = await response.json();

            // Filter posts by current language
            const currentLang = document.documentElement.lang || "en";
            posts = allPosts.filter((post: any) => post.lang === currentLang);

            const options = {
                keys: [
                    { name: "title", weight: 2 },
                    { name: "description", weight: 1.5 },
                    { name: "categories", weight: 1 },
                    { name: "tags", weight: 0.5 },
                ],
                threshold: 0.3,
                minMatchCharLength: 2,
                includeScore: true,
            };

            fuse = new Fuse(posts, options);
        } catch (error) {
            console.error("Failed to load search index:", error);
        }
    }

    // Perform search
    function performHeaderSearch(query: string) {
        const searchResults = document.getElementById("headerSearchResults");
        if (!searchResults) return;

        if (!query || query.length < 2) {
            searchResults.innerHTML =
                '<div class="text-center py-8"><p class="text-gray-400 dark:text-gray-500 text-base">Start typing to search...</p></div>';
            return;
        }

        if (!fuse) {
            searchResults.innerHTML =
                '<p class="text-gray-600 dark:text-gray-400 text-center py-12">Search index not loaded. Please refresh the page.</p>';
            return;
        }

        const results = fuse.search(query).slice(0, 10); // Show top 10 results

        if (results.length === 0) {
            searchResults.innerHTML = `
        <div class="text-center py-8">
          <p class="text-gray-500 dark:text-gray-400 text-base">No results found for "${query}"</p>
          <p class="text-gray-400 dark:text-gray-500 text-sm mt-1">Try different keywords</p>
        </div>
      `;
            return;
        }

        searchResults.innerHTML = `
      <div class="space-y-1">
        ${results
            .map((result) => {
                const post = result.item;
                return `
            <a 
              href="${post.url}" 
              class="block px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors rounded-lg group"
            >
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <div class="flex-1 min-w-0">
                  <h3 class="font-medium text-gray-900 dark:text-gray-100 group-hover:text-primary mb-1 line-clamp-1">
                    ${post.title}
                  </h3>
                  ${
                      post.description
                          ? `
                    <p class="text-gray-500 dark:text-gray-400 text-sm line-clamp-1">${post.description}</p>
                  `
                          : ""
                  }
                  <div class="flex items-center gap-2 mt-1">
                    <time class="text-xs text-gray-400 dark:text-gray-500">
                      ${new Date(post.date).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}
                    </time>
                    ${
                        post.categories && post.categories.length > 0
                            ? `
                      <span class="text-gray-300 dark:text-gray-600">•</span>
                      <span class="text-xs text-gray-400 dark:text-gray-500 capitalize">${post.categories[0]}</span>
                    `
                            : ""
                    }
                  </div>
                </div>
              </div>
            </a>
          `;
            })
            .join("")}
      </div>
    `;
    }

    // Debounce function
    function debounce<T extends (...args: any[]) => any>(
        func: T,
        wait: number,
    ): (...args: Parameters<T>) => void {
        let timeout: ReturnType<typeof setTimeout> | null = null;
        return function (...args: Parameters<T>) {
            if (timeout) clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }

    // Initialize on page load
    function setupHeaderSearch() {
        const searchToggles = document.querySelectorAll(".search-toggle");
        const searchModal = document.getElementById("searchModal");
        const searchBackdrop = document.getElementById("searchBackdrop");
        const closeSearch = document.getElementById("closeSearch");
        const searchInput = document.getElementById(
            "headerSearchInput",
        ) as HTMLInputElement;
        const searchResults = document.getElementById("headerSearchResults");

        if (searchToggles.length === 0 || !searchModal || !searchInput) return;

        // Open modal
        const openModal = () => {
            searchModal?.classList.remove("hidden");
            document.body.style.overflow = "hidden"; // Prevent body scroll
            setTimeout(() => searchInput?.focus(), 100);
            if (searchResults) {
                searchResults.innerHTML =
                    '<div class="text-center py-8"><p class="text-gray-400 dark:text-gray-500 text-base">Start typing to search...</p></div>';
            }
        };

        // Close modal
        const closeModal = () => {
            searchModal?.classList.add("hidden");
            document.body.style.overflow = ""; // Restore body scroll
            if (searchInput) searchInput.value = "";
            if (searchResults) searchResults.innerHTML = "";
        };

        // Add click event listeners to all search toggle buttons
        searchToggles.forEach(toggle => {
            toggle.addEventListener("click", openModal);
        });

        // Close button
        closeSearch?.addEventListener("click", closeModal);

        // Close when clicking backdrop
        searchBackdrop?.addEventListener("click", closeModal);

        // Search on input
        const debouncedSearch = debounce(performHeaderSearch, 300);
        searchInput.addEventListener("input", (e) => {
            debouncedSearch((e.target as HTMLInputElement).value);
        });

        // Close on Escape key
        document.addEventListener("keydown", (e) => {
            if (
                e.key === "Escape" &&
                !searchModal?.classList.contains("hidden")
            ) {
                closeModal();
            }
        });

        // Quick access: Cmd/Ctrl + K to open search
        document.addEventListener("keydown", (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === "k") {
                e.preventDefault();
                openModal();
            }
        });
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
        initHeaderSearch();
        setupHeaderSearch();
    });

    // Re-initialize after view transitions
    document.addEventListener("astro:after-swap", () => {
        initHeaderSearch();
        setupHeaderSearch();
    });
</script>

<style>
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
