---
import "../styles/global.css";
import Modal from "../components/Modal.astro";
import ThemeToggle from "../components/ThemeToggle.astro";
import SearchButton from "../components/SearchButton.astro";
import SearchModal from "../components/SearchModal.astro";
import LanguageSwitcher from "../components/LanguageSwitcher.astro";
import { SITE } from "../config";
import { useTranslations } from "../utils/i18n";

interface Props {
    title: string;
    description?: string;
    image?: string;
    canonicalURL?: string;
    lang?: "en" | "vi";
}

const {
    title,
    description = t("site.description"),
    image = `${SITE.url}/og-image.png`,
    canonicalURL = new URL(Astro.url.pathname, SITE.url).toString(),
    lang = "en",
} = Astro.props;

const t = useTranslations(lang);
const langPrefix = lang === "en" ? "" : `/${lang}`;
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
    <head>
        <meta charset="utf-8" />

        <!-- Favicons -->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16x16.png"
        />
        <link rel="manifest" href="/site.webmanifest" />
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#19a485" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <meta name="msapplication-TileColor" content="#19a485" />
        <meta name="msapplication-config" content="/browserconfig.xml" />
        <meta name="theme-color" content="#ffffff" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content={Astro.generator} />

        <!-- Prevent flash of unstyled content (FOUC) for dark mode -->
        <script is:inline>
            // Check for saved theme preference or default to 'light'
            const theme = localStorage.getItem("theme") || "light";
            if (theme === "dark") {
                document.documentElement.classList.add("dark");
            }
        </script>

        <!-- Google Analytics (GA4) - Exclude localhost -->
        {SITE.ga4MeasurementId && (
            <>
                <script is:inline define:vars={{ measurementId: SITE.ga4MeasurementId }}>
                    // Only load Google Analytics if not on localhost
                    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                        // Load gtag.js
                        var script = document.createElement('script');
                        script.async = true;
                        script.src = 'https://www.googletagmanager.com/gtag/js?id=' + measurementId;
                        document.head.appendChild(script);

                        // Initialize gtag
                        window.dataLayer = window.dataLayer || [];
                        function gtag(){dataLayer.push(arguments);}
                        gtag('js', new Date());
                        gtag('config', measurementId);
                    }
                </script>
            </>
        )}

        <!-- SEO Meta Tags -->
        <title>{title}</title>
        <meta name="description" content={description} />
        <meta name="author" content={SITE.author} />
        <link rel="canonical" href={canonicalURL} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={image} />
        <meta property="og:site_name" content={SITE.title} />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={canonicalURL} />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={image} />

        <!-- Image Caption Script for Mobile -->
        <script is:inline>
            (function () {
                function addImageCaptions() {
                    // Find all images in the main content area that have alt text
                    const mainContent = document.querySelector("main");
                    if (!mainContent) return;

                    const images = mainContent.querySelectorAll(
                        'img[alt]:not([alt=""])',
                    );

                    images.forEach(function (img) {
                        // Skip if already wrapped
                        if (
                            img.parentElement.classList.contains(
                                "img-with-caption",
                            )
                        ) {
                            return;
                        }

                        const altText = img.getAttribute("alt");
                        if (!altText) return;

                        // Create wrapper div
                        const wrapper = document.createElement("div");
                        wrapper.className = "img-with-caption";

                        // Create caption element
                        const caption = document.createElement("span");
                        caption.className = "img-caption";
                        caption.textContent = altText;

                        // Insert wrapper before image
                        img.parentNode.insertBefore(wrapper, img);

                        // Move image into wrapper
                        wrapper.appendChild(img);

                        // Add caption after image
                        wrapper.appendChild(caption);
                    });
                }

                // Initialize when DOM is ready
                if (document.readyState === "loading") {
                    document.addEventListener(
                        "DOMContentLoaded",
                        addImageCaptions,
                    );
                } else {
                    addImageCaptions();
                }
            })();
        </script>
    </head>
    <body
        class="min-h-screen flex flex-col bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors"
    >
        <header
            class="sticky top-0 z-50 w-full border-b border-stone-100 dark:border-gray-800 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md transition-all"
        >
            <nav
                class="max-w-5xl mx-auto px-4 sm:px-6 h-16 sm:h-20 flex items-center justify-between"
            >
                <!-- Logo -->
                <a
                    href={`${langPrefix}/`}
                    class="flex items-center gap-2 sm:gap-3 text-lg sm:text-heading-m font-bold text-content hover:text-primary transition-colors"
                >
                    <img
                        src="/logo.png"
                        alt="Iced Tea Labs Logo"
                        class="h-8 w-8 sm:h-10 sm:w-10 object-contain"
                    />
                    <span class="hidden sm:inline">{SITE.title}</span>
                </a>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center gap-6 lg:gap-8">
                    <a
                        href={`${langPrefix}/`}
                        class="text-body-base font-medium text-content-muted hover:text-primary transition-colors"
                    >
                        {t("nav.home")}
                    </a>
                    <a
                        href={`${langPrefix}/categories`}
                        class="text-body-base font-medium text-content-muted hover:text-primary transition-colors"
                    >
                        {t("nav.categories")}
                    </a>
                    <a
                        href={`${langPrefix}/tags`}
                        class="text-body-base font-medium text-content-muted hover:text-primary transition-colors"
                    >
                        {t("nav.tags")}
                    </a>
                    <a
                        href={`${langPrefix}/about`}
                        class="text-body-base font-medium text-content-muted hover:text-primary transition-colors"
                    >
                        {t("nav.about")}
                    </a>
                    <LanguageSwitcher lang={lang} />
                    <SearchButton />
                    <ThemeToggle />
                </div>

                <!-- Mobile Navigation -->
                <div class="flex md:hidden items-center gap-3">
                    <LanguageSwitcher lang={lang} />
                    <SearchButton />
                    <ThemeToggle />
                    <!-- Mobile Menu Button -->
                    <button
                        id="mobile-menu-button"
                        class="p-2 text-content-muted hover:text-primary transition-colors"
                        aria-label="Toggle menu"
                    >
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </nav>
        </header>

        <!-- Mobile Menu Overlay (outside header to avoid z-index issues) -->
        <div
            id="mobile-menu"
            class="md:hidden fixed inset-0 top-16 sm:top-20 bg-white dark:bg-gray-900 z-50 overflow-y-auto transition-all duration-300 ease-in-out opacity-0 translate-y-[-10px] pointer-events-none"
            style="visibility: hidden;"
        >
            <div class="flex flex-col p-6 gap-4">
                <a
                    href={`${langPrefix}/`}
                    class="text-lg font-medium text-content-muted hover:text-primary transition-colors py-2 border-b border-stone-100 dark:border-gray-800"
                >
                    {t("nav.home")}
                </a>
                <a
                    href={`${langPrefix}/categories`}
                    class="text-lg font-medium text-content-muted hover:text-primary transition-colors py-2 border-b border-stone-100 dark:border-gray-800"
                >
                    {t("nav.categories")}
                </a>
                <a
                    href={`${langPrefix}/tags`}
                    class="text-lg font-medium text-content-muted hover:text-primary transition-colors py-2 border-b border-stone-100 dark:border-gray-800"
                >
                    {t("nav.tags")}
                </a>
                <a
                    href={`${langPrefix}/about`}
                    class="text-lg font-medium text-content-muted hover:text-primary transition-colors py-2 border-b border-stone-100 dark:border-gray-800"
                >
                    {t("nav.about")}
                </a>
            </div>
        </div>

        <!-- Mobile Menu Script -->
        <script is:inline>
            (function () {
                function initMobileMenu() {
                    const menuButton =
                        document.getElementById("mobile-menu-button");
                    const mobileMenu = document.getElementById("mobile-menu");

                    if (!menuButton || !mobileMenu) {
                        return;
                    }

                    let isOpen = false;

                    function openMenu() {
                        isOpen = true;
                        mobileMenu.style.visibility = "visible";
                        mobileMenu.style.pointerEvents = "auto";
                        // Trigger reflow to ensure transition works
                        mobileMenu.offsetHeight;
                        mobileMenu.classList.remove(
                            "opacity-0",
                            "translate-y-[-10px]",
                        );
                        mobileMenu.classList.add(
                            "opacity-100",
                            "translate-y-0",
                        );
                        document.body.style.overflow = "hidden";
                    }

                    function closeMenu() {
                        isOpen = false;
                        mobileMenu.classList.remove(
                            "opacity-100",
                            "translate-y-0",
                        );
                        mobileMenu.classList.add(
                            "opacity-0",
                            "translate-y-[-10px]",
                        );
                        document.body.style.overflow = "";
                        // Wait for transition to complete before hiding
                        setTimeout(function () {
                            if (!isOpen) {
                                mobileMenu.style.visibility = "hidden";
                                mobileMenu.style.pointerEvents = "none";
                            }
                        }, 300);
                    }

                    // Toggle menu on button click
                    menuButton.addEventListener("click", function (e) {
                        e.stopPropagation();

                        if (isOpen) {
                            closeMenu();
                        } else {
                            openMenu();
                        }

                        // Toggle icon between hamburger and X
                        const svg = menuButton.querySelector("svg path");
                        if (svg) {
                            if (isOpen) {
                                svg.setAttribute("d", "M6 18L18 6M6 6l12 12"); // X icon
                            } else {
                                svg.setAttribute(
                                    "d",
                                    "M4 6h16M4 12h16M4 18h16",
                                ); // Hamburger icon
                            }
                        }
                    });

                    // Close menu when clicking on a link
                    const menuLinks = mobileMenu.querySelectorAll("a");
                    menuLinks.forEach(function (link) {
                        link.addEventListener("click", function () {
                            closeMenu();
                            const svg = menuButton.querySelector("svg path");
                            if (svg) {
                                svg.setAttribute(
                                    "d",
                                    "M4 6h16M4 12h16M4 18h16",
                                ); // Reset to hamburger
                            }
                        });
                    });

                    // Close menu when clicking outside
                    document.addEventListener("click", function (e) {
                        if (
                            isOpen &&
                            !mobileMenu.contains(e.target) &&
                            !menuButton.contains(e.target)
                        ) {
                            closeMenu();
                            const svg = menuButton.querySelector("svg path");
                            if (svg) {
                                svg.setAttribute(
                                    "d",
                                    "M4 6h16M4 12h16M4 18h16",
                                );
                            }
                        }
                    });
                }

                // Initialize immediately if DOM is ready, otherwise wait
                if (document.readyState === "loading") {
                    document.addEventListener(
                        "DOMContentLoaded",
                        initMobileMenu,
                    );
                } else {
                    initMobileMenu();
                }
            })();
        </script>
        <!-- Search Modal (outside header to avoid stacking context issues) -->
        <SearchModal />

        <main class="flex-grow">
            <slot />
        </main>
        <div
            class="max-w-5xl mx-auto px-6 py-12 flex flex-col md:flex-row justify-between items-center gap-6"
        >
            <div class="text-center md:text-left">
                <span class="text-heading-s font-bold text-content block mb-2"
                    >{SITE.title}</span
                >
                <p class="text-body-s text-content-muted">
                    {t("site.description")}
                </p>
            </div>
            <div class="flex gap-6">
                <a
                    href="https://github.com"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-content-muted hover:text-primary transition-colors"
                    >GitHub</a
                >
                <a
                    href="https://twitter.com"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-content-muted hover:text-primary transition-colors"
                    >Twitter</a
                >
                <a
                    href={`${langPrefix}/rss.xml`}
                    class="text-content-muted hover:text-primary transition-colors"
                    >RSS</a
                >
            </div>
            <p class="text-caption text-content-subtle">
                Â© {new Date().getFullYear()}
                {SITE.author}. {t("footer.rights")}
            </p>
        </div>
    </body>
</html>
