---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const sortedPosts = posts.sort(
  (a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf()
);

// Get unique categories and tags
const allCategories = [...new Set(posts.map((post) => post.data.category).filter(Boolean))];
const allTags = [...new Set(posts.flatMap((post) => post.data.tags || []).filter(Boolean))].sort();

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

function getDifficultyLabel(difficulty?: 'easy' | 'medium' | 'hard'): string {
  const labels = { easy: 'Easy', medium: 'Medium', hard: 'Hard' };
  return difficulty ? labels[difficulty] : '';
}

function getTotalTime(prepTime?: number, cookTime?: number): string {
  const total = (prepTime || 0) + (cookTime || 0);
  if (total === 0) return '';
  if (total < 60) return `${total} min`;
  const hours = Math.floor(total / 60);
  const mins = total % 60;
  return mins > 0 ? `${hours}h ${mins}min` : `${hours}h`;
}
---

<BaseLayout title="Blog" description="Discover our latest food recipes and articles">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <header class="mb-12">
      <h1 class="text-display-l text-content mb-3 font-serif">Food Blog</h1>
      <p class="text-body-base text-content-muted">
        Discover our latest recipes, cooking tips, and culinary adventures.
      </p>
    </header>

    <!-- Search and Filter Section -->
    <div class="mb-10 space-y-6">
      <!-- Search Bar -->
      <div class="relative">
        <input
          type="text"
          id="search-input"
          placeholder="Search articles..."
          class="w-full pl-11 pr-4 py-3 bg-surface-1 border border-surface-3 rounded-lg text-body-base focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
        />
        <svg class="absolute left-4 top-3.5 w-5 h-5 text-content-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2" id="category-filters">
          <button 
            class="category-btn px-4 py-1.5 rounded-full text-caption font-medium transition-colors bg-gray-900 text-white"
            data-value="all"
          >
            All
          </button>
          {allCategories.map((category) => (
            <button 
              class="category-btn px-4 py-1.5 rounded-full text-caption font-medium transition-colors bg-surface-2 text-content-muted hover:bg-surface-2"
              data-value={category}
            >
              {category}
            </button>
          ))}
        </div>

        <!-- Tag Filter -->
        <div class="relative min-w-[200px]">
          <select 
            id="tag-filter"
            class="w-full appearance-none bg-surface-1 border border-surface-3 text-content-muted py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-surface-1 focus:border-gray-500"
          >
            <option value="">All Tags</option>
            {allTags.map((tag) => (
              <option value={tag}>{tag}</option>
            ))}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-content-muted">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

    {sortedPosts.length === 0 ? (
      <div class="text-center py-16">
        <p class="text-body-base text-content-subtle">No articles yet. Check back soon!</p>
      </div>
    ) : (
      <div class="space-y-6" id="posts-grid">
        {sortedPosts.map((post) => (
          <article 
            class="group blog-post"
            data-title={post.data.title.toLowerCase()}
            data-category={post.data.category}
            data-tags={post.data.tags?.join(',') || ''}
          >
            <a 
              href={`/blog/${post.slug}`}
              class="block p-4 bg-surface-1 hover:bg-surface-2 rounded-md transition-colors"
            >
              <div class="flex gap-4">
                {post.data.image && (
                  <div class="flex-shrink-0 w-32 h-24 bg-surface-3 rounded overflow-hidden">
                    <img 
                      src={post.data.image} 
                      alt={post.data.imageAlt || post.data.title}
                      class="w-full h-full object-cover"
                    />
                  </div>
                )}
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-caption text-content-subtle uppercase">{post.data.category}</span>
                    {post.data.difficulty && (
                      <>
                        <span class="text-gray-300">•</span>
                        <span class="text-caption text-content-subtle">{getDifficultyLabel(post.data.difficulty)}</span>
                      </>
                    )}
                    {(post.data.prepTime || post.data.cookTime) && (
                      <>
                        <span class="text-gray-300">•</span>
                        <span class="text-caption text-content-subtle">{getTotalTime(post.data.prepTime, post.data.cookTime)}</span>
                      </>
                    )}
                  </div>
                  <h2 class="text-heading-m text-gray-950 group-hover:text-content-muted transition-colors mb-1 truncate">
                    {post.data.title}
                  </h2>
                  <p class="text-body-s text-content-muted line-clamp-2">
                    {post.data.description}
                  </p>
                  <p class="text-caption text-content-subtle mt-2">
                    {formatDate(post.data.publishedAt)}
                  </p>
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>
    )}
    
    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-16">
      <p class="text-body-base text-content-subtle">No articles found matching your criteria.</p>
    </div>
  </div>
</BaseLayout>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const categoryButtons = document.querySelectorAll('.category-btn');
  const tagFilter = document.getElementById('tag-filter') as HTMLSelectElement;
  const posts = document.querySelectorAll('.blog-post');
  const noResults = document.getElementById('no-results');

  let currentSearch = '';
  let currentCategory = 'all';
  let currentTag = '';

  function filterPosts() {
    let visibleCount = 0;

    posts.forEach((post) => {
      const title = (post as HTMLElement).dataset.title || '';
      const category = (post as HTMLElement).dataset.category || '';
      const tags = ((post as HTMLElement).dataset.tags || '').split(',');

      const matchesSearch = title.includes(currentSearch.toLowerCase());
      const matchesCategory = currentCategory === 'all' || category === currentCategory;
      const matchesTag = currentTag === '' || tags.includes(currentTag);

      if (matchesSearch && matchesCategory && matchesTag) {
        (post as HTMLElement).style.display = 'block';
        visibleCount++;
      } else {
        (post as HTMLElement).style.display = 'none';
      }
    });

    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }

  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value;
      filterPosts();
    });
  }

  categoryButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      // Update active state
      categoryButtons.forEach((b) => {
        b.classList.remove('bg-gray-900', 'text-white');
        b.classList.add('bg-surface-2', 'text-content-muted');
      });
      
      btn.classList.remove('bg-surface-2', 'text-content-muted');
      btn.classList.add('bg-gray-900', 'text-white');

      currentCategory = (btn as HTMLElement).dataset.value || 'all';
      filterPosts();
    });
  });

  if (tagFilter) {
    tagFilter.addEventListener('change', (e) => {
      currentTag = (e.target as HTMLSelectElement).value;
      filterPosts();
    });
  }
</script>
