---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import PageViewCounter from '../../components/PageViewCounter.astro';
import { SITE } from '../../config';
import { readingTime } from '../../utils/readingTime';

export const prerender = true;

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  
  return blogEntries.map((entry) => {
    // Extract category from the entry's id (e.g., 'android/2024-11-20-post.md' -> 'android')
    const category = entry.id.split('/')[0];
    
    // Extract slug from filename (e.g., '2024-11-20-xcode-error-no-such-module.md' -> 'xcode-error-no-such-module')
    const filename = entry.id.split('/')[1];
    const slug = filename.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/\.md$/, '');
    
    return {
      params: { category, slug },
      props: { entry },
    };
  });
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const { category, slug } = Astro.params;

// Check if TOC should be shown
const showTOC = entry.data.toc !== false && headings.length > 0;

// Calculate reading time
const readTime = readingTime(entry.body);

// Format date
const formattedDate = new Date(entry.data.date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Get related posts from same category
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter((post) => {
    const postCategory = post.id.split('/')[0];
    return postCategory === category && post.id !== entry.id;
  })
  .slice(0, 3);

// SEO metadata
const pageTitle = `${entry.data.title} | ${SITE.title}`;
const pageDescription = entry.data.description || entry.data.title;
const pageImage = entry.data.image || `${SITE.url}/og-image.png`;
const canonicalURL = `${SITE.url}/${category}/${slug}/`;

// JSON-LD structured data for SEO
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: entry.data.title,
  description: pageDescription,
  image: pageImage,
  datePublished: entry.data.date.toISOString(),
  dateModified: entry.data.date.toISOString(),
  author: {
    '@type': 'Person',
    name: SITE.author,
    url: SITE.url,
  },
  publisher: {
    '@type': 'Organization',
    name: SITE.title,
    logo: {
      '@type': 'ImageObject',
      url: `${SITE.url}/logo.png`,
    },
  },
  url: canonicalURL,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalURL,
  },
  keywords: entry.data.tags?.join(', ') || '',
  articleSection: entry.data.categories?.[0] || category,
  wordCount: entry.body.split(/\s+/).length,
  timeRequired: `PT${readTime}M`,
};
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
  canonicalURL={canonicalURL}
>
  <!-- JSON-LD Structured Data for SEO -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} slot="head" />
  
  <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Main Content -->
      <article class={showTOC ? "lg:w-3/4" : "max-w-4xl mx-auto w-full"}>
        <!-- Breadcrumb -->
        <nav class="text-sm mb-6 text-content-muted">
          <a href="/" class="hover:text-primary">Home</a>
          <span class="mx-2">/</span>
          <a href={`/category/${category}`} class="hover:text-primary capitalize">{category}</a>
          <span class="mx-2">/</span>
          <span class="text-content">{entry.data.title}</span>
        </nav>

        <!-- Article Header -->
        <header class="mb-8">
          <h1 class="text-4xl font-bold mb-4 text-content">
            {entry.data.title}
          </h1>
          
          <div class="flex flex-wrap items-center gap-4 text-sm text-content-muted">
            <time datetime={entry.data.date.toISOString()}>
              {formattedDate}
            </time>
            <span>•</span>
            <span>{readTime} min read</span>
            {SITE.pageViews?.enabled && (
              <>
                <span>•</span>
                <PageViewCounter pageKey={`${category}/${slug}`} />
              </>
            )}
            
            {entry.data.categories && entry.data.categories.length > 0 && (
              <>
                <span>•</span>
                <div class="flex gap-2">
                  {entry.data.categories.map((cat: string) => (
                    <a 
                      href={`/category/${cat}`}
                      class="px-2 py-1 bg-primary-light text-primary-hover rounded hover:bg-primary-light capitalize"
                    >
                      {cat}
                    </a>
                  ))}
                </div>
              </>
            )}
          </div>

          {entry.data.tags && entry.data.tags.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {entry.data.tags.map((tag: string) => (
                <a 
                  href={`/tag/${tag}`}
                  class="text-sm px-3 py-1 bg-surface-2 text-content-muted rounded-full hover:bg-surface-3">
                  #{tag}
                </a>
              ))}
            </div>
          )}
        </header>

        <!-- Featured Image -->
        {entry.data.image && (
          <div class="mb-8">
            <img 
              src={entry.data.image} 
              alt={entry.data.title}
              class="w-full h-auto rounded-lg shadow-lg"
            />
          </div>
        )}

        <!-- Article Content -->
        <div class="prose prose-lg max-w-none mb-12">
          <Content />
        </div>

            <!-- Article Footer -->
        <footer class="border-t pt-8 mt-12">
      <!-- Share Buttons -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold mb-4">Share this article</h3>
        <div class="flex gap-4">
          <a
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(entry.data.title)}&url=${encodeURIComponent(canonicalURL)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="px-4 py-2 bg-primary text-white rounded hover:bg-primary"
          >
            Twitter
          </a>
          <a
            href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(canonicalURL)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="px-4 py-2 bg-primary-hover text-white rounded hover:bg-primary-hover"
          >
            Facebook
          </a>
          <a
            href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(canonicalURL)}&title=${encodeURIComponent(entry.data.title)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="px-4 py-2 bg-primary text-white rounded hover:bg-primary-hover"
          >
            LinkedIn
          </a>
        </div>
      </div>

      <!-- Related Posts -->
      {relatedPosts.length > 0 && (
        <div class="mt-12">
          <h3 class="text-2xl font-bold mb-6">Related Posts</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {relatedPosts.map((post) => {
              const postSlug = post.id.split('/')[1].replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/\.md$/, '');
              const postCategory = post.id.split('/')[0];
              return (
                <article class="border border-surface-3 rounded-lg p-4 hover:shadow-lg transition-shadow bg-surface-1">
                  <a href={`/${postCategory}/${postSlug}/`}>
                    <h4 class="font-semibold text-content mb-2 hover:text-primary">
                      {post.data.title}
                    </h4>
                    <p class="text-sm text-content-muted">
                      {new Date(post.data.date).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                      })}
                    </p>
                  </a>
                </article>
              );
            })}
          </div>
        </div>
      )}

      <!-- Giscus Comments -->
      {entry.data.comments !== false && SITE.comments?.enabled && SITE.comments?.provider === 'giscus' && SITE.comments.giscus?.repoId && SITE.comments.giscus?.categoryId && (
        <div class="mt-12">
          <h3 class="text-2xl font-bold mb-6 text-content">Comments</h3>
          <script 
            src="https://giscus.app/client.js"
            data-repo={SITE.comments.giscus.repo}
            data-repo-id={SITE.comments.giscus.repoId}
            data-category={SITE.comments.giscus.category}
            data-category-id={SITE.comments.giscus.categoryId}
            data-mapping={SITE.comments.giscus.mapping}
            data-strict="0"
            data-reactions-enabled={SITE.comments.giscus.reactionsEnabled ? "1" : "0"}
            data-emit-metadata={SITE.comments.giscus.emitMetadata ? "1" : "0"}
            data-input-position={SITE.comments.giscus.inputPosition}
            data-theme={SITE.comments.giscus.theme}
            data-lang={SITE.comments.giscus.lang}
            crossorigin="anonymous"
            async>
          </script>
        </div>
      )}
        </footer>
      </article>

      <!-- Table of Contents Sidebar -->
      {showTOC && (
        <aside class="hidden lg:block lg:w-1/4">
          <div class="sticky top-24">
            <TableOfContents headings={headings} maxDepth={3} />
          </div>
        </aside>
      )}
    </div>
  </div>

  <style>
    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
    }
    
    /* Add scroll margin to headings for better positioning */
    article :is(h1, h2, h3, h4, h5, h6) {
      scroll-margin-top: 6rem;
    }

    /* Image caption styling */
    .image-caption {
      display: block;
      text-align: center;
      font-style: italic;
      font-size: 0.75rem;
      color: #888;
      margin-top: 0.5rem;
      margin-bottom: 1.5rem;
    }

    /* Wrapper for image and caption */
    .image-wrapper {
      margin: 1.5rem auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-wrapper img {
      margin-bottom: 0.5rem;
    }

    /* Landscape images - full width */
    .image-wrapper.landscape img {
      width: 100%;
      max-width: 100%;
      height: auto;
    }

    /* Portrait images - 40% width */
    .image-wrapper.portrait img {
      width: 40%;
      max-width: 40%;
      height: auto;
    }

    /* Ensure images don't exceed their natural size */
    .image-wrapper img {
      object-fit: contain;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      /* On mobile, portrait images take 70% width for better visibility */
      .image-wrapper.portrait img {
        width: 70%;
        max-width: 70%;
      }
    }
  </style>

  <script>
    // Add captions to images and apply orientation-based sizing
    document.addEventListener('DOMContentLoaded', () => {
      // Find all images in the article content
      const articleContent = document.querySelector('.prose');
      if (!articleContent) return;

      const images = articleContent.querySelectorAll('img');
      
      images.forEach((img) => {
        // Function to process image after it's loaded
        const processImage = () => {
          const altText = img.getAttribute('alt');
          
          // Create a wrapper div for the image and caption
          const wrapper = document.createElement('div');
          wrapper.className = 'image-wrapper';
          
          // Determine image orientation
          const width = img.naturalWidth;
          const height = img.naturalHeight;
          
          if (width > height) {
            // Landscape orientation
            wrapper.classList.add('landscape');
          } else {
            // Portrait orientation
            wrapper.classList.add('portrait');
          }
          
          // Insert wrapper before the image
          img.parentNode.insertBefore(wrapper, img);
          
          // Move image into wrapper
          wrapper.appendChild(img);
          
          // Add caption if alt text exists
          if (altText && altText.trim()) {
            const caption = document.createElement('p');
            caption.className = 'image-caption';
            caption.textContent = altText;
            wrapper.appendChild(caption);
          }
        };

        // Check if image is already loaded
        if (img.complete && img.naturalWidth > 0) {
          processImage();
        } else {
          // Wait for image to load
          img.addEventListener('load', processImage);
        }
      });
    });
  </script>
</BaseLayout>
